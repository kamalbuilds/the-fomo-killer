<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ”¯ä»˜æµç¨‹æµ‹è¯•</title>
    <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .step {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        .step.active {
            background-color: #e3f2fd;
            border-color: #2196f3;
        }
        .step.completed {
            background-color: #e8f5e9;
            border-color: #4caf50;
        }
        button {
            background-color: #2196f3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background-color: #1976d2;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .error {
            color: #f44336;
            margin: 10px 0;
        }
        .success {
            color: #4caf50;
            margin: 10px 0;
        }
        .info {
            color: #2196f3;
            margin: 10px 0;
        }
        .result {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            overflow-x: auto;
        }
        .payment-link {
            display: inline-block;
            background-color: #4caf50;
            color: white;
            padding: 15px 30px;
            text-decoration: none;
            border-radius: 5px;
            margin: 20px 0;
            font-size: 18px;
        }
        .payment-link:hover {
            background-color: #45a049;
        }
        .membership-info {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ æ”¯ä»˜æµç¨‹æµ‹è¯•</h1>
        
        <div class="step" id="step1">
            <h3>æ­¥éª¤ 1: è¿æ¥é’±åŒ…</h3>
            <button onclick="connectWallet()">è¿æ¥ MetaMask</button>
            <div id="walletInfo"></div>
        </div>

        <div class="step" id="step2">
            <h3>æ­¥éª¤ 2: ç™»å½•è®¤è¯</h3>
            <button onclick="login()" disabled id="loginBtn">ä½¿ç”¨é’±åŒ…ç™»å½•</button>
            <div id="loginInfo"></div>
        </div>

        <div class="step" id="step3">
            <h3>æ­¥éª¤ 3: åˆ›å»ºæ”¯ä»˜è®¢å•</h3>
            <div>
                <label>ä¼šå‘˜ç±»å‹ï¼š</label>
                <select id="membershipType">
                    <option value="plus">Plus (1 USDT/æœˆ - æµ‹è¯•ä»·æ ¼)</option>
                    <option value="pro">Pro (200 USDT/æœˆ)</option>
                </select>
                <br><br>
                <label>è®¢é˜…æ–¹å¼ï¼š</label>
                <select id="subscriptionType">
                    <option value="monthly">æœˆä»˜</option>
                    <option value="yearly">å¹´ä»˜</option>
                </select>
            </div>
            <br>
            <button onclick="createPayment()" disabled id="paymentBtn">åˆ›å»ºæ”¯ä»˜è®¢å•</button>
            <div id="paymentInfo"></div>
        </div>

        <div class="step" id="step4">
            <h3>æ­¥éª¤ 4: å®Œæˆæ”¯ä»˜</h3>
            <div id="checkoutLink"></div>
            <button onclick="checkPaymentStatus()" disabled id="checkBtn">æ£€æŸ¥æ”¯ä»˜çŠ¶æ€</button>
            <div id="paymentStatus"></div>
        </div>

        <div class="step" id="step5">
            <h3>æ­¥éª¤ 5: éªŒè¯ä¼šå‘˜çŠ¶æ€</h3>
            <button onclick="checkMembership()" disabled id="membershipBtn">æ£€æŸ¥ä¼šå‘˜çŠ¶æ€</button>
            <div id="membershipStatus"></div>
        </div>

        <div class="step">
            <h3>æ—¥å¿—</h3>
            <div id="logs" class="result"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3001';
        let provider, signer, address, token, currentPaymentId;

        function log(message, type = 'info') {
            const logs = document.getElementById('logs');
            const time = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'blue';
            logs.innerHTML += `<div style="color: ${color}">[${time}] ${message}</div>`;
            logs.scrollTop = logs.scrollHeight;
        }

        async function connectWallet() {
            try {
                if (typeof window.ethereum === 'undefined') {
                    throw new Error('è¯·å®‰è£… MetaMask!');
                }

                provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                signer = provider.getSigner();
                address = await signer.getAddress();

                document.getElementById('walletInfo').innerHTML = 
                    `<div class="success">âœ… å·²è¿æ¥é’±åŒ…: ${address}</div>`;
                document.getElementById('loginBtn').disabled = false;
                document.getElementById('step1').classList.add('completed');
                
                log(`é’±åŒ…è¿æ¥æˆåŠŸ: ${address}`, 'success');
            } catch (error) {
                document.getElementById('walletInfo').innerHTML = 
                    `<div class="error">âŒ ${error.message}</div>`;
                log(error.message, 'error');
            }
        }

        async function login() {
            try {
                document.getElementById('step2').classList.add('active');
                log('å¼€å§‹ç™»å½•æµç¨‹...');

                // è·å– nonce
                const nonceResponse = await fetch(`${API_BASE}/api/auth/wallet/nonce`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ address })
                });
                const { nonce } = await nonceResponse.json();
                log(`è·å– nonce: ${nonce}`);

                // åˆ›å»º SIWE æ¶ˆæ¯
                const domain = window.location.host || 'localhost:3001';
                const uri = window.location.origin || 'http://localhost:3001';
                const statement = 'Sign in with Ethereum to the app.';
                const chainId = await signer.getChainId();
                const issuedAt = new Date().toISOString();

                const message = `${domain} wants you to sign in with your Ethereum account:
${address}

${statement}

URI: ${uri}
Version: 1
Chain ID: ${chainId}
Nonce: ${nonce}
Issued At: ${issuedAt}`;

                log('è¯·åœ¨ MetaMask ä¸­ç­¾å...');

                // ç­¾å
                const signature = await signer.signMessage(message);
                log('ç­¾åæˆåŠŸ');

                // ç™»å½•
                const loginResponse = await fetch(`${API_BASE}/api/auth/wallet/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message, signature })
                });
                
                const loginData = await loginResponse.json();
                if (!loginResponse.ok) {
                    throw new Error(loginData.error || 'ç™»å½•å¤±è´¥');
                }

                token = loginData.accessToken;
                document.getElementById('loginInfo').innerHTML = 
                    `<div class="success">âœ… ç™»å½•æˆåŠŸï¼ç”¨æˆ·ID: ${loginData.user.id}</div>`;
                document.getElementById('paymentBtn').disabled = false;
                document.getElementById('step2').classList.remove('active');
                document.getElementById('step2').classList.add('completed');
                
                log('ç™»å½•æˆåŠŸ!', 'success');
            } catch (error) {
                document.getElementById('loginInfo').innerHTML = 
                    `<div class="error">âŒ ${error.message}</div>`;
                log(error.message, 'error');
            }
        }

        async function createPayment() {
            try {
                document.getElementById('step3').classList.add('active');
                const membershipType = document.getElementById('membershipType').value;
                const subscriptionType = document.getElementById('subscriptionType').value;
                
                log(`åˆ›å»ºæ”¯ä»˜è®¢å•: ${membershipType} ${subscriptionType}`);

                const response = await fetch(`${API_BASE}/api/payment/create-payment`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ membershipType, subscriptionType })
                });

                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.error || 'åˆ›å»ºæ”¯ä»˜å¤±è´¥');
                }

                currentPaymentId = data.data.paymentId;
                const checkoutUrl = data.data.checkoutUrl;

                document.getElementById('paymentInfo').innerHTML = 
                    `<div class="success">âœ… æ”¯ä»˜è®¢å•åˆ›å»ºæˆåŠŸï¼</div>
                     <div class="info">æ”¯ä»˜ID: ${currentPaymentId}</div>`;
                
                document.getElementById('checkoutLink').innerHTML = 
                    `<a href="${checkoutUrl}" target="_blank" class="payment-link">
                        ç‚¹å‡»å‰å¾€ Coinbase Commerce æ”¯ä»˜
                    </a>
                    <div class="info">æ”¯ä»˜é‡‘é¢: 1 USDT (æµ‹è¯•ä»·æ ¼)</div>`;
                
                document.getElementById('checkBtn').disabled = false;
                document.getElementById('membershipBtn').disabled = false;
                document.getElementById('step3').classList.remove('active');
                document.getElementById('step3').classList.add('completed');
                document.getElementById('step4').classList.add('active');
                
                log('æ”¯ä»˜è®¢å•åˆ›å»ºæˆåŠŸ!', 'success');
                log(`æ”¯ä»˜é“¾æ¥: ${checkoutUrl}`);
            } catch (error) {
                document.getElementById('paymentInfo').innerHTML = 
                    `<div class="error">âŒ ${error.message}</div>`;
                log(error.message, 'error');
            }
        }

        async function checkPaymentStatus() {
            try {
                log('æ£€æŸ¥æ”¯ä»˜çŠ¶æ€...');

                const response = await fetch(`${API_BASE}/api/payment/payment/${currentPaymentId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.error || 'è·å–æ”¯ä»˜çŠ¶æ€å¤±è´¥');
                }

                const payment = data.data;
                let statusHtml = `
                    <div class="membership-info">
                        <strong>æ”¯ä»˜çŠ¶æ€:</strong> ${payment.status}<br>
                        <strong>ä¼šå‘˜ç±»å‹:</strong> ${payment.membershipType}<br>
                        <strong>è®¢é˜…æ–¹å¼:</strong> ${payment.subscriptionType}<br>
                        <strong>åˆ›å»ºæ—¶é—´:</strong> ${new Date(payment.createdAt).toLocaleString()}
                `;

                if (payment.confirmedAt) {
                    statusHtml += `<br><strong>ç¡®è®¤æ—¶é—´:</strong> ${new Date(payment.confirmedAt).toLocaleString()}`;
                    document.getElementById('step4').classList.remove('active');
                    document.getElementById('step4').classList.add('completed');
                    document.getElementById('step5').classList.add('active');
                }

                statusHtml += '</div>';
                document.getElementById('paymentStatus').innerHTML = statusHtml;
                
                log(`æ”¯ä»˜çŠ¶æ€: ${payment.status}`, payment.status === 'confirmed' ? 'success' : 'info');
            } catch (error) {
                document.getElementById('paymentStatus').innerHTML = 
                    `<div class="error">âŒ ${error.message}</div>`;
                log(error.message, 'error');
            }
        }

        async function checkMembership() {
            try {
                log('æ£€æŸ¥ä¼šå‘˜çŠ¶æ€...');

                const response = await fetch(`${API_BASE}/api/payment/membership-status`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.error || 'è·å–ä¼šå‘˜çŠ¶æ€å¤±è´¥');
                }

                const membership = data.data;
                let statusHtml = `
                    <div class="membership-info">
                        <strong>ä¼šå‘˜æ¿€æ´»:</strong> ${membership.isActive ? 'âœ… æ˜¯' : 'âŒ å¦'}<br>
                `;

                if (membership.isActive) {
                    statusHtml += `
                        <strong>ä¼šå‘˜ç±»å‹:</strong> ${membership.membershipType}<br>
                        <strong>è®¢é˜…æ–¹å¼:</strong> ${membership.subscriptionType}<br>
                        <strong>åˆ°æœŸæ—¶é—´:</strong> ${new Date(membership.expiresAt).toLocaleString()}
                    `;
                    document.getElementById('step5').classList.remove('active');
                    document.getElementById('step5').classList.add('completed');
                }

                statusHtml += '</div>';
                document.getElementById('membershipStatus').innerHTML = statusHtml;
                
                log(`ä¼šå‘˜çŠ¶æ€: ${membership.isActive ? 'æ¿€æ´»' : 'æœªæ¿€æ´»'}`, 
                    membership.isActive ? 'success' : 'info');
            } catch (error) {
                document.getElementById('membershipStatus').innerHTML = 
                    `<div class="error">âŒ ${error.message}</div>`;
                log(error.message, 'error');
            }
        }

        // é¡µé¢åŠ è½½æ—¶çš„æç¤º
        window.onload = function() {
            log('æ”¯ä»˜æµ‹è¯•é¡µé¢å·²åŠ è½½');
            log('Plus æœˆä»˜å·²è®¾ç½®ä¸º 1 USDT æµ‹è¯•ä»·æ ¼');
            log('è¯·å…ˆè¿æ¥ MetaMask é’±åŒ…å¼€å§‹æµ‹è¯•');
        };
    </script>
</body>
</html> 