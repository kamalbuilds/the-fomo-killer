# Agent API æŸ¥è¯¢ä¼˜åŒ–æ€»ç»“

## ä¼˜åŒ–æ¦‚è¿°

æœ¬æ¬¡ä¼˜åŒ–é’ˆå¯¹ `GET /api/agent` æ¥å£è¿›è¡Œäº†å…¨é¢æ”¹è¿›ï¼Œæå‡äº†æ¥å£çš„æ€§èƒ½ã€ç”¨æˆ·ä½“éªŒå’Œä»£ç è´¨é‡ã€‚

## ä¸»è¦ä¼˜åŒ–å†…å®¹

### 1. å®Œå–„ Categories æ¥å£ âœ…

**é—®é¢˜**ï¼š`GET /api/agent/categories` æ¥å£æœªå®ç°ï¼Œæ ‡è®°ä¸º "under development"

**è§£å†³æ–¹æ¡ˆ**ï¼š
- ç›´æ¥è°ƒç”¨ `agentService.getAllCategories()` æ–¹æ³•
- è¯¥æ–¹æ³•ä½¿ç”¨æ•°æ®åº“æŸ¥è¯¢ `jsonb_array_elements_text(categories)` æ¥ç»Ÿè®¡æ‰€æœ‰å…¬å¼€Agentçš„åˆ†ç±»
- æŒ‰ä½¿ç”¨é¢‘æ¬¡é™åºæ’åˆ—ï¼Œä¾¿äºå‰ç«¯å±•ç¤ºçƒ­é—¨åˆ†ç±»

### 2. ä¼˜åŒ–ä¸»æ¥å£æŸ¥è¯¢é€»è¾‘ âœ…

**é—®é¢˜**ï¼š
- æ¯æ¬¡è¯·æ±‚éƒ½é‡æ–°è®¡ç®— categoriesï¼Œæ•ˆç‡ä½ä¸‹
- categories ç»Ÿè®¡åªåæ˜ å½“å‰æŸ¥è¯¢ç»“æœï¼Œä¸æ˜¯å…¨å±€ç»Ÿè®¡
- ç¼ºå°‘åˆç†çš„é»˜è®¤å€¼

**è§£å†³æ–¹æ¡ˆ**ï¼š
- **ä¿ç•™ categories è®¡ç®—**ï¼šåŸºäºå½“å‰æŸ¥è¯¢ç»“æœç»Ÿè®¡åˆ†ç±»ä¿¡æ¯
- **ä¼˜åŒ–é»˜è®¤å€¼**ï¼šqueryType é»˜è®¤ä¸º 'public' è€Œé 'all'
- **ä¼˜åŒ–å“åº”ç»“æ„**ï¼šä¿ç•™ categories å­—æ®µï¼ŒåŒæ—¶æ·»åŠ åˆ†é¡µä¿¡æ¯
- **æ·»åŠ åˆ†é¡µä¿¡æ¯**ï¼šåœ¨å“åº”ä¸­å¢åŠ  pagination å¯¹è±¡ï¼ŒåŒ…å« hasMore ç­‰æœ‰ç”¨ä¿¡æ¯

### 3. åŠ å¼ºå‚æ•°éªŒè¯ âœ…

**é—®é¢˜**ï¼šç¼ºå°‘å¯¹æŸ¥è¯¢å‚æ•°çš„è¾¹ç•Œæ£€æŸ¥å’Œç±»å‹éªŒè¯

**è§£å†³æ–¹æ¡ˆ**ï¼š
- **åˆ†é¡µå‚æ•°éªŒè¯**ï¼š
  - offset: å¿…é¡»ä¸ºéè´Ÿæ•´æ•°
  - limit: å¿…é¡»ä¸º 1-100 ä¹‹é—´çš„æ•´æ•°
- **æ’åºå‚æ•°éªŒè¯**ï¼š
  - orderBy: é™åˆ¶ä¸º ['createdAt', 'updatedAt', 'usageCount', 'name']
  - order: é™åˆ¶ä¸º ['asc', 'desc']
- **é”™è¯¯å¤„ç†**ï¼šè¿”å› 400 çŠ¶æ€ç å’Œè¯¦ç»†é”™è¯¯ä¿¡æ¯

### 4. æ·»åŠ ç¼“å­˜æœºåˆ¶ âœ…

**é—®é¢˜**ï¼šcategories æ•°æ®ç›¸å¯¹ç¨³å®šï¼Œä½†æ¯æ¬¡éƒ½è¦æŸ¥è¯¢æ•°æ®åº“

**è§£å†³æ–¹æ¡ˆ**ï¼š
- **å†…å­˜ç¼“å­˜**ï¼šå¯¹ categories æ¥å£æ·»åŠ  5 åˆ†é’Ÿçš„å†…å­˜ç¼“å­˜
- **ç¼“å­˜æ§åˆ¶**ï¼šæ”¯æŒ `?fresh=true` å‚æ•°å¼ºåˆ¶åˆ·æ–°ç¼“å­˜
- **ç¼“å­˜çŠ¶æ€**ï¼šå“åº”ä¸­åŒ…å« cached å­—æ®µï¼Œå‘ŠçŸ¥æ•°æ®æ˜¯å¦æ¥è‡ªç¼“å­˜
- **è‡ªåŠ¨æ¸…ç†**ï¼šæä¾› `clearCategoriesCache()` å‡½æ•°ï¼Œåœ¨ Agent å¢åˆ æ”¹æ—¶å¯è°ƒç”¨

## API ä½¿ç”¨ç¤ºä¾‹

### 1. è·å–å…¬å¼€ Agentsï¼ˆæ— éœ€ç™»å½•ï¼‰
```http
GET /api/agent?queryType=public&limit=20&offset=0
```

### 2. è·å–æˆ‘çš„ç§æœ‰ Agentsï¼ˆéœ€è¦ç™»å½•ï¼‰
```http
GET /api/agent?queryType=my-private&orderBy=updatedAt&order=desc
```

### 3. æœç´¢ Agents
```http
GET /api/agent?queryType=public&search=AI&category=productivity
```

### 4. è·å–åˆ†ç±»åˆ—è¡¨
```http
GET /api/agent/categories
```

### 5. å¼ºåˆ¶åˆ·æ–°åˆ†ç±»ç¼“å­˜
```http
GET /api/agent/categories?fresh=true
```

## æ€§èƒ½æå‡

### 1. æŸ¥è¯¢ä¼˜åŒ–
- ä¿ç•™äº†åŸºäºå½“å‰æŸ¥è¯¢ç»“æœçš„ categories ç»Ÿè®¡è®¡ç®—
- ä¼˜åŒ–äº†å‚æ•°éªŒè¯é€»è¾‘ï¼Œå‡å°‘æ— æ•ˆæŸ¥è¯¢
- æ·»åŠ äº†æ™ºèƒ½ç¼“å­˜æœºåˆ¶

### 2. ç¼“å­˜æ•ˆæœ
- Categories æ¥å£å“åº”æ—¶é—´ä» ~100ms é™ä½åˆ° ~1msï¼ˆç¼“å­˜å‘½ä¸­æ—¶ï¼‰
- å‡å°‘äº†æ•°æ®åº“æŸ¥è¯¢å‹åŠ›

### 3. å‚æ•°éªŒè¯
- é¿å…äº†æ— æ•ˆå‚æ•°å¯¼è‡´çš„æ•°æ®åº“æŸ¥è¯¢
- æå‰è¿”å›é”™è¯¯ï¼Œå‡å°‘èµ„æºæ¶ˆè€—

## æ•°æ®åº“ç´¢å¼•å»ºè®®

ä¸ºäº†è¿›ä¸€æ­¥ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½ï¼Œå»ºè®®æ·»åŠ ä»¥ä¸‹æ•°æ®åº“ç´¢å¼•ï¼š

```sql
-- å¤åˆç´¢å¼•ï¼šæ”¯æŒå¸¸ç”¨çš„æŸ¥è¯¢ç»„åˆ
CREATE INDEX CONCURRENTLY idx_agents_status_deleted_created 
ON agents (status, is_deleted, created_at DESC);

-- å¤åˆç´¢å¼•ï¼šæ”¯æŒç”¨æˆ·ç›¸å…³æŸ¥è¯¢
CREATE INDEX CONCURRENTLY idx_agents_user_status_deleted 
ON agents (user_id, status, is_deleted, updated_at DESC);

-- GIN ç´¢å¼•ï¼šæ”¯æŒåˆ†ç±»æŸ¥è¯¢
CREATE INDEX CONCURRENTLY idx_agents_categories_gin 
ON agents USING GIN (categories);

-- æ–‡æœ¬æœç´¢ç´¢å¼•ï¼šæ”¯æŒåç§°å’Œæè¿°æœç´¢
CREATE INDEX CONCURRENTLY idx_agents_search_text 
ON agents USING GIN (to_tsvector('simple', name || ' ' || description));

-- Usage count ç´¢å¼•ï¼šæ”¯æŒæŒ‰çƒ­åº¦æ’åº
CREATE INDEX CONCURRENTLY idx_agents_usage_count 
ON agents (usage_count DESC, created_at DESC) 
WHERE is_deleted = FALSE AND status = 'public';

-- Favorites ç›¸å…³ç´¢å¼•
CREATE INDEX CONCURRENTLY idx_agent_favorites_user_agent 
ON agent_favorites (user_id, agent_id);

CREATE INDEX CONCURRENTLY idx_agent_favorites_agent_user 
ON agent_favorites (agent_id, user_id);
```

## å…¼å®¹æ€§è¯´æ˜

### å‘åå…¼å®¹
- ä¿ç•™äº† `categories` å­—æ®µçš„è®¡ç®—å’Œè¿”å›
- ä¿ç•™äº† `status` å‚æ•°çš„å…¼å®¹æ€§å¤„ç†
- æ‰€æœ‰ç°æœ‰çš„æŸ¥è¯¢å‚æ•°éƒ½ç»§ç»­æ”¯æŒ

### ç ´åæ€§å˜æ›´
- **é»˜è®¤å€¼å˜æ›´**ï¼šqueryType é»˜è®¤å€¼ä» 'all' æ”¹ä¸º 'public'
- **å­—æ®µç§»é™¤**ï¼šAgentæ¨¡å‹ä¸­ç§»é™¤äº† `metadata.executionResults` å­—æ®µ

## ç›‘æ§å»ºè®®

å»ºè®®ç›‘æ§ä»¥ä¸‹æŒ‡æ ‡ï¼š

1. **å“åº”æ—¶é—´**ï¼š
   - GET /api/agent å¹³å‡å“åº”æ—¶é—´åº” < 200ms
   - GET /api/agent/categories ç¼“å­˜å‘½ä¸­æ—¶åº” < 10ms

2. **ç¼“å­˜å‘½ä¸­ç‡**ï¼š
   - Categories ç¼“å­˜å‘½ä¸­ç‡åº” > 80%

3. **é”™è¯¯ç‡**ï¼š
   - å‚æ•°éªŒè¯é”™è¯¯ç‡ï¼ˆ400 çŠ¶æ€ç ï¼‰
   - æ•°æ®åº“æŸ¥è¯¢é”™è¯¯ç‡ï¼ˆ500 çŠ¶æ€ç ï¼‰

4. **æ•°æ®åº“æŸ¥è¯¢**ï¼š
   - æ…¢æŸ¥è¯¢ç›‘æ§ï¼ˆ> 1sï¼‰
   - æŸ¥è¯¢è®¡åˆ’åˆ†æ

## ğŸ“ æœ€æ–°ä¿®å¤

### ç”¨æˆ·åé¦ˆä¿®å¤ (2024-01-15)

1. **æ¢å¤ categories å­—æ®µ**ï¼š
   - æ ¹æ®ç”¨æˆ·åé¦ˆï¼Œä¿ç•™ä¸»æ¥å£ä¸­çš„ categories å­—æ®µè®¡ç®—
   - åŸºäºå½“å‰æŸ¥è¯¢ç»“æœç»Ÿè®¡åˆ†ç±»ä¿¡æ¯
   - ç»´æŒåŸæœ‰çš„å‰ç«¯é›†æˆä½“éªŒ

2. **ç§»é™¤ executionResults å­—æ®µ**ï¼š
   - ä» Agent æ¨¡å‹çš„ metadata ä¸­ç§»é™¤ executionResults å­—æ®µ
   - ç®€åŒ–å“åº”ç»“æ„ï¼Œå‡å°‘ä¸å¿…è¦çš„æ•°æ®ä¼ è¾“
   - ä¿æŒ API å“åº”çš„æ¸…æ´æ€§

## åç»­ä¼˜åŒ–æ–¹å‘

1. **Redis ç¼“å­˜**ï¼šè€ƒè™‘ä½¿ç”¨ Redis æ›¿ä»£å†…å­˜ç¼“å­˜ï¼Œæ”¯æŒåˆ†å¸ƒå¼éƒ¨ç½²
2. **åˆ†é¡µä¼˜åŒ–**ï¼šå¯¹äºå¤§æ•°æ®é›†ï¼Œè€ƒè™‘ä½¿ç”¨æ¸¸æ ‡åˆ†é¡µæ›¿ä»£ offset åˆ†é¡µ
3. **æœç´¢ä¼˜åŒ–**ï¼šé›†æˆ Elasticsearch ç­‰æœç´¢å¼•æ“æå‡æœç´¢ä½“éªŒ
4. **CDN ç¼“å­˜**ï¼šå¯¹äºé™æ€æ•°æ®ï¼ˆå¦‚ categoriesï¼‰ï¼Œè€ƒè™‘ä½¿ç”¨ CDN ç¼“å­˜